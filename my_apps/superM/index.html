<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Super Mario Bros - Full Level Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <style>
    html, body {
      height: 100%; margin: 0;
      background: #7ecbff;
      font-family: 'Courier New', Courier, monospace;
      overflow: hidden; touch-action: none; user-select: none; -webkit-user-select: none;
    }
    .app { height: 100%; display: flex; align-items: center; justify-content: center; }
    .screen {
      width: min(1100px, 100vw); height: min(420px, 100vh);
      background: #7ecbff; position: relative;
    }
    
    /* HUD overlay text */
    .hud {
      position: absolute; left: 16px; top: 16px;
      color: #fff; font-weight: bold; font-size: 20px; z-index: 20;
      text-shadow: 2px 2px 0px #000; display: flex; gap: 40px;
    }

    /* Touch controls */
    .touch-controls { position: absolute; bottom: 20px; left: 20px; z-index: 30; display: flex; gap: 15px; }
    .touch-controls-right { position: absolute; bottom: 20px; right: 20px; z-index: 30; }
    .touch-btn {
      width: 70px; height: 70px; border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.5); background: rgba(0,0,0,0.2);
      color: #fff; font-size: 24px; display: flex; align-items: center; justify-content: center;
    }
    .touch-btn.active { background: rgba(255,255,255,0.4); transform: scale(0.95); }

    svg { display: block; width: 100%; height: 100%; }
    .pixel-art * { shape-rendering: crispEdges; }
    .hidden { display: none !important; }

    /* Win Message */
    #win-msg {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: white; font-size: 40px; text-shadow: 3px 3px 0 #000; z-index: 50; display: none; text-align: center;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="screen">
      <div class="hud">
        <div id="score">MARIO<br>000000</div>
        <div id="coins-display">COINS<br>0</div>
      </div>
      
      <div id="win-msg">COURSE CLEAR!<br><span style="font-size: 20px">Vibe Coded on Termux</span></div>

      <div class="touch-controls">
        <div id="btn-left" class="touch-btn">◀</div>
        <div id="btn-right" class="touch-btn">▶</div>
      </div>
      <div class="touch-controls-right">
        <div id="btn-jump" class="touch-btn">A</div>
      </div>

      <svg viewBox="0 0 1100 420" preserveAspectRatio="xMinYMin slice" id="game-svg">
        <defs>
          <pattern id="brickPattern" width="48" height="48" patternUnits="userSpaceOnUse">
            <rect width="48" height="48" fill="#c65b2a"/><rect x="0" y="0" width="48" height="4" fill="#f9bc9a"/>
            <rect x="0" y="24" width="48" height="4" fill="#f9bc9a"/><rect x="0" y="0" width="4" height="24" fill="#f9bc9a"/>
            <rect x="24" y="24" width="4" height="24" fill="#f9bc9a"/><rect x="0" y="20" width="48" height="4" fill="#5c260f"/>
            <rect x="0" y="44" width="48" height="4" fill="#5c260f"/>
          </pattern>
          <pattern id="groundPattern" width="48" height="48" patternUnits="userSpaceOnUse">
            <rect width="48" height="48" fill="#c65b2a"/><rect x="0" y="0" width="48" height="4" fill="#f9bc9a"/>
            <rect x="0" y="44" width="48" height="4" fill="#5c260f"/>
          </pattern>
          <g id="coin"><circle cx="24" cy="24" r="16" fill="#f6c93e" stroke="#b46f16" stroke-width="4"/><rect x="20" y="14" width="8" height="20" fill="#b46f16"/></g>
          
          <g id="marioA" class="pixel-art" transform="scale(3)">
            <rect x="6" y="0" width="6" height="2" fill="#d10000"/><rect x="4" y="2" width="10" height="2" fill="#d10000"/><rect x="4" y="4" width="4" height="2" fill="#2b1b0c"/><rect x="8" y="4" width="6" height="2" fill="#f3c199"/><rect x="4" y="6" width="2" height="2" fill="#2b1b0c"/><rect x="6" y="6" width="8" height="2" fill="#f3c199"/><rect x="4" y="8" width="10" height="2" fill="#d10000"/><rect x="2" y="10" width="14" height="4" fill="#0b58a6"/><rect x="2" y="14" width="4" height="2" fill="#6b2412"/><rect x="10" y="14" width="4" height="2" fill="#6b2412"/>
          </g>
          <g id="goombaArt" transform="scale(3)">
            <rect x="4" y="0" width="8" height="4" fill="#b25a2b"/><rect x="2" y="4" width="12" height="4" fill="#b25a2b"/><rect x="4" y="6" width="2" height="2" fill="#fff"/><rect x="10" y="6" width="2" height="2" fill="#fff"/><rect x="4" y="8" width="8" height="2" fill="#f3c199"/><rect x="2" y="10" width="4" height="2" fill="#000"/><rect x="10" y="10" width="4" height="2" fill="#000"/>
          </g>
          <g id="flagpole">
            <rect x="20" y="40" width="8" height="332" fill="#c2c2c2"/>
            <circle cx="24" cy="30" r="10" fill="#8bd46a"/>
            <polygon id="flag" points="28,40 28,80 -10,60" fill="#8bd46a"/>
          </g>
        </defs>

        <g id="world">
          <rect id="floor" x="0" y="372" width="4000" height="48" fill="url(#groundPattern)"/>
          
          <g id="blocks-layer"></g>
          <g id="coins-layer"></g>
          <g id="enemies-layer"></g>
          
          <use href="#flagpole" x="3200" y="0"/>

          <g id="mario" transform="translate(100, 324)">
            <use href="#marioA"/>
          </g>
        </g>
      </svg>
    </div>
  </div>

  <script>
    // --- Engine Setup ---
    const svg = document.getElementById('game-svg');
    const marioEl = document.getElementById('mario');
    const blocksLayer = document.getElementById('blocks-layer');
    const coinsLayer = document.getElementById('coins-layer');
    const enemiesLayer = document.getElementById('enemies-layer');
    const winMsg = document.getElementById('win-msg');
    
    // Virtual resolution
    const VIEW_WIDTH = 1100;
    
    // Input State
    const keys = { left: false, right: false, jump: false };

    // Player State
    let mario = {
      x: 100, y: 324, width: 42, height: 48, // Hitbox size
      vx: 0, vy: 0, grounded: true, facing: 1, state: 'playing', coins: 0
    };

    // Physics Constants
    const GRAVITY = 2200;
    const SPEED = 350;
    const JUMP_SPEED = -850;

    // --- Level Data ---
    // We define the level as objects. JS will draw them and use them for collisions.
    const levelBlocks = [
      { x: 400, y: 220, w: 192, h: 48 }, // Floating platform
      { x: 800, y: 280, w: 96, h: 96 },  // Pipe/Stair
      { x: 1300, y: 220, w: 48, h: 48 }, // Single block
      { x: 1396, y: 220, w: 48, h: 48 },
      { x: 1700, y: 324, w: 48, h: 48 }, // Staircase
      { x: 1748, y: 276, w: 48, h: 96 },
      { x: 1796, y: 228, w: 48, h: 144 },
    ];

    const levelCoins = [
      { id: 'c1', x: 450, y: 150, collected: false },
      { id: 'c2', x: 500, y: 150, collected: false },
      { id: 'c3', x: 1300, y: 150, collected: false },
      { id: 'c4', x: 1396, y: 150, collected: false }
    ];

    const levelEnemies = [
      { id: 'e1', x: 650, y: 324, w: 48, h: 48, vx: -100, alive: true },
      { id: 'e2', x: 1100, y: 324, w: 48, h: 48, vx: -100, alive: true },
      { id: 'e3', x: 2000, y: 324, w: 48, h: 48, vx: -100, alive: true }
    ];

    const FLAG_X = 3220;

    // --- Initialize Level Graphics ---
    function buildLevel() {
      levelBlocks.forEach(b => {
        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        rect.setAttribute("x", b.x); rect.setAttribute("y", b.y);
        rect.setAttribute("width", b.w); rect.setAttribute("height", b.h);
        rect.setAttribute("fill", "url(#brickPattern)");
        blocksLayer.appendChild(rect);
      });

      levelCoins.forEach(c => {
        const use = document.createElementNS("http://www.w3.org/2000/svg", "use");
        use.setAttribute("href", "#coin");
        use.setAttribute("x", c.x); use.setAttribute("y", c.y);
        use.setAttribute("id", c.id);
        coinsLayer.appendChild(use);
      });

      levelEnemies.forEach(e => {
        const use = document.createElementNS("http://www.w3.org/2000/svg", "use");
        use.setAttribute("href", "#goombaArt");
        use.setAttribute("id", e.id);
        enemiesLayer.appendChild(use);
      });
    }

    // --- Collision Detection (AABB) ---
    // Returns true if two rectangles overlap
    function checkCollision(r1, r2) {
      return r1.x < r2.x + r2.w && r1.x + r1.width > r2.x &&
             r1.y < r2.y + r2.h && r1.y + r1.height > r2.y;
    }

    // --- Input Binding ---
    function bindTouch(id, keyName) {
      const el = document.getElementById(id);
      if (!el) return;
      const press = (e) => { e.preventDefault(); keys[keyName] = true; el.classList.add('active'); };
      const release = (e) => { e.preventDefault(); keys[keyName] = false; el.classList.remove('active'); };
      el.addEventListener('touchstart', press); el.addEventListener('touchend', release);
      el.addEventListener('mousedown', press); el.addEventListener('mouseup', release);
    }
    bindTouch('btn-left', 'left'); bindTouch('btn-right', 'right'); bindTouch('btn-jump', 'jump');

    window.addEventListener('keydown', (e) => {
      if (e.code === 'ArrowLeft') keys.left = true;
      if (e.code === 'ArrowRight') keys.right = true;
      if (e.code === 'Space') keys.jump = true;
    });
    window.addEventListener('keyup', (e) => {
      if (e.code === 'ArrowLeft') keys.left = false;
      if (e.code === 'ArrowRight') keys.right = false;
      if (e.code === 'Space') keys.jump = false;
    });

    // --- Game Loop ---
    let lastTime = performance.now();
    buildLevel();

    function gameLoop(now) {
      let dt = Math.min((now - lastTime) / 1000, 0.05); // Cap delta time
      lastTime = now;

      if (mario.state === 'playing') {
        // 1. Apply Input
        if (keys.left) { mario.vx = -SPEED; mario.facing = -1; }
        else if (keys.right) { mario.vx = SPEED; mario.facing = 1; }
        else { mario.vx = 0; }

        if (keys.jump && mario.grounded) {
          mario.vy = JUMP_SPEED;
          mario.grounded = false;
        }

        // 2. Apply Gravity
        mario.vy += GRAVITY * dt;

        // 3. Move X & Check Block Collisions
        mario.x += mario.vx * dt;
        if (mario.x < 0) mario.x = 0; // Left boundary

        levelBlocks.forEach(b => {
          if (checkCollision(mario, b)) {
            // Hit a wall
            if (mario.vx > 0) mario.x = b.x - mario.width;
            else if (mario.vx < 0) mario.x = b.x + b.w;
          }
        });

        // 4. Move Y & Check Block Collisions
        mario.y += mario.vy * dt;
        mario.grounded = false;

        // Check Floor
        if (mario.y + mario.height >= 372) {
          mario.y = 372 - mario.height;
          mario.vy = 0;
          mario.grounded = true;
        }

        levelBlocks.forEach(b => {
          if (checkCollision(mario, b)) {
            if (mario.vy > 0) { // Landing on top
              mario.y = b.y - mario.height;
              mario.vy = 0;
              mario.grounded = true;
            } else if (mario.vy < 0) { // Hitting head
              mario.y = b.y + b.h;
              mario.vy = 0;
            }
          }
        });

        // 5. Enemy Interactions
        levelEnemies.forEach(e => {
          if (!e.alive) return;
          
          // Move enemy
          e.x += e.vx * dt;
          // Simple patrol boundary (reverse if they walk 150px)
          if (e.x % 150 < 2) e.vx *= -1; 
          
          document.getElementById(e.id).setAttribute('transform', `translate(${e.x}, ${e.y})`);

          // Collision with Mario
          if (checkCollision(mario, e)) {
            if (mario.vy > 0 && mario.y + mario.height < e.y + 24) {
              // Stomp Goomba
              e.alive = false;
              document.getElementById(e.id).classList.add('hidden');
              mario.vy = -600; // Bounce
            } else {
              // Mario takes damage (simplified: just reset level)
              mario.x = 100; mario.y = 324;
            }
          }
        });

        // 6. Coin Collection
        levelCoins.forEach(c => {
          if (!c.collected && checkCollision(mario, {x: c.x, y: c.y, w: 48, h: 48})) {
            c.collected = true;
            mario.coins++;
            document.getElementById(c.id).classList.add('hidden');
            document.getElementById('coins-display').innerHTML = `COINS<br>${mario.coins}`;
          }
        });

        // 7. Win Condition (Flagpole)
        if (mario.x > FLAG_X) {
          mario.state = 'won';
          mario.x = FLAG_X - 10;
          mario.vy = 200; // Slide down
          winMsg.style.display = 'block';
        }
      } else if (mario.state === 'won') {
        // Slide down the flag
        if (mario.y + mario.height < 372) {
          mario.y += 200 * dt;
        }
      }

      // 8. Render Mario
      marioEl.setAttribute('transform', `translate(${mario.x}, ${mario.y}) scale(${mario.facing}, 1)`);

      // 9. Update Camera (Scroll SVG ViewBox)
      // Camera tries to keep Mario in the middle of the screen
      let cameraX = mario.x - (VIEW_WIDTH / 2);
      if (cameraX < 0) cameraX = 0; // Don't scroll past the left edge
      if (cameraX > 4000 - VIEW_WIDTH) cameraX = 4000 - VIEW_WIDTH; // Right edge

      svg.setAttribute('viewBox', `${cameraX} 0 1100 420`);

      requestAnimationFrame(gameLoop);
    }

    requestAnimationFrame(gameLoop);
  </script>
</body>
</html>
