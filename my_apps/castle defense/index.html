<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ACORNIX: Sorcerer's Last Stand</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Nunito:wght@700;900&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;touch-action:none}
body{overflow:hidden;background:#87ceeb;font-family:'Nunito',sans-serif;user-select:none}
canvas{display:block;position:absolute;inset:0}

/* â”€â”€ HUD â”€â”€ */
#hud{position:absolute;inset:0;pointer-events:none;z-index:10}

#top-bar{
  position:absolute;top:0;left:0;right:0;
  display:flex;justify-content:space-between;align-items:flex-start;
  padding:10px 12px;gap:8px;
  background:linear-gradient(to bottom,rgba(255,255,255,.55) 0%,transparent 100%);
}
.panel{
  background:rgba(255,255,255,.75);
  border:2px solid rgba(120,60,200,.35);border-radius:14px;
  padding:8px 14px;backdrop-filter:blur(6px);
  box-shadow:0 2px 12px rgba(100,50,200,.15);
}
.plabel{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#7744bb;margin-bottom:3px;font-weight:700}
.pval{font-family:'Cinzel Decorative',serif;font-size:18px;color:#33006f;line-height:1}

#hp-wrap{width:150px;height:11px;background:rgba(200,180,255,.3);border-radius:6px;overflow:hidden;margin-top:5px;border:1.5px solid rgba(150,100,255,.35)}
#hp-fill{height:100%;width:100%;border-radius:6px;background:linear-gradient(90deg,#ff5555,#ffaa00,#aaff44);transition:width .3s;box-shadow:0 0 6px rgba(255,150,0,.4)}

#spell-panel{text-align:center;min-width:110px}
#spell-icon{font-size:24px;display:block;margin-bottom:2px}
#spell-name{font-size:11px;color:#c05000;font-weight:900;letter-spacing:1px}

/* â”€â”€ WAVE ANNOUNCE â”€â”€ */
#wave-ann{position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);text-align:center;display:none;z-index:20;pointer-events:none}
#wave-ann .wt{font-family:'Cinzel Decorative',serif;font-size:clamp(24px,6vw,56px);color:#5500aa;text-shadow:2px 2px 0 #fff,0 0 20px rgba(180,80,255,.5);animation:pop .4s ease}
#wave-ann .ws{font-size:13px;color:#8833cc;letter-spacing:3px;text-transform:uppercase;margin-top:5px;font-weight:700}

/* â”€â”€ UNLOCK â”€â”€ */
#unlock-msg{position:absolute;top:35%;left:50%;transform:translate(-50%,-50%);text-align:center;display:none;z-index:20;pointer-events:none}
#unlock-msg .ut{font-family:'Cinzel Decorative',serif;font-size:clamp(16px,4vw,32px);color:#ff6600;text-shadow:2px 2px 0 #fff;animation:pop .5s cubic-bezier(.34,1.56,.64,1)}
#unlock-msg .us{font-size:12px;color:#cc4400;margin-top:4px;letter-spacing:2px;font-weight:700}

/* â”€â”€ KILL FEED â”€â”€ */
#kfeed{position:absolute;right:12px;top:100px;display:flex;flex-direction:column;gap:4px;align-items:flex-end;pointer-events:none}
.kitem{font-size:11px;color:#440088;background:rgba(255,255,255,.8);border-left:3px solid #aa44ff;padding:3px 9px;border-radius:5px;animation:kslide .25s ease;font-weight:700}

/* â”€â”€ BOTTOM CONTROLS â”€â”€ */
#controls{
  position:absolute;bottom:0;left:0;right:0;
  padding:10px 12px 14px;
  background:linear-gradient(to top,rgba(255,255,255,.6) 0%,transparent 100%);
  display:flex;flex-direction:column;gap:8px;align-items:center;
  pointer-events:all;
}

/* Spell bar */
#spell-bar{display:flex;gap:8px}
.sslot{
  width:56px;height:56px;border-radius:14px;
  background:rgba(255,255,255,.8);border:2.5px solid rgba(150,80,255,.4);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  font-size:20px;position:relative;cursor:pointer;
  box-shadow:0 3px 10px rgba(100,50,200,.15);transition:all .15s;
}
.sslot:active{transform:scale(.92)}
.sslot.sel{border-color:#ff8800;box-shadow:0 0 0 3px rgba(255,150,0,.35),0 3px 10px rgba(255,120,0,.2);background:rgba(255,240,220,.95)}
.sslot.locked{opacity:.35;filter:grayscale(1)}
.sslot .sk{position:absolute;bottom:2px;right:5px;font-size:8px;color:#9966cc;font-weight:700}
.sslot .slv{position:absolute;top:2px;left:4px;font-size:8px;color:#cc6600;font-weight:700}

/* Ability row */
#ability-bar{display:flex;gap:10px}
.abtn{
  height:52px;border-radius:14px;padding:0 18px;
  background:rgba(255,255,255,.85);border:2.5px solid rgba(150,80,255,.4);
  display:flex;align-items:center;gap:7px;cursor:pointer;
  font-size:20px;font-family:'Nunito',sans-serif;font-weight:900;
  color:#5500aa;box-shadow:0 3px 10px rgba(100,50,200,.15);
  transition:all .15s;position:relative;white-space:nowrap;
}
.abtn:active{transform:scale(.93)}
.abtn .alabel{font-size:11px;color:#7722bb;letter-spacing:1px}
.abtn .acd{
  position:absolute;inset:0;border-radius:12px;
  background:rgba(200,180,240,.8);
  display:none;align-items:center;justify-content:center;
  font-size:14px;font-weight:900;color:#5500aa;
}
.abtn .acd.show{display:flex}

/* AIM INDICATOR */
#aim-dot{
  position:absolute;width:44px;height:44px;
  border-radius:50%;border:3px solid rgba(255,150,0,.85);
  box-shadow:0 0 12px rgba(255,150,0,.5);
  pointer-events:none;z-index:8;
  transform:translate(-50%,-50%);display:none;
}
#aim-dot::before,#aim-dot::after{content:'';position:absolute;background:rgba(255,150,0,.9)}
#aim-dot::before{width:2px;height:100%;left:50%;top:0;margin-left:-1px}
#aim-dot::after{height:2px;width:100%;top:50%;left:0;margin-top:-1px}

/* HEALTH FLASH */
#dmg-flash{position:absolute;inset:0;background:rgba(255,0,0,.0);pointer-events:none;z-index:6;transition:background .1s}

/* GAME OVER */
#gameover{display:none;position:absolute;inset:0;background:rgba(80,0,120,.75);z-index:100;flex-direction:column;align-items:center;justify-content:center;pointer-events:all;backdrop-filter:blur(5px)}
#gameover.show{display:flex}
#gameover h1{font-family:'Cinzel Decorative',serif;font-size:clamp(28px,8vw,72px);color:#fff;text-shadow:0 0 30px #ff44aa;letter-spacing:3px}
.fscore{font-size:18px;color:rgba(255,230,100,.95);margin:14px 0 22px;letter-spacing:2px;font-weight:700}
.gbtn{font-family:'Nunito',sans-serif;font-weight:900;font-size:18px;color:#fff;background:linear-gradient(135deg,#9933ff,#ff6600);border:none;padding:14px 38px;border-radius:16px;cursor:pointer;box-shadow:0 4px 20px rgba(150,50,255,.4);transition:transform .15s}
.gbtn:active{transform:scale(.95)}

/* INTRO */
#intro{position:absolute;inset:0;z-index:200;background:linear-gradient(160deg,#d4aaff 0%,#7fd8ff 50%,#ffe8aa 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:12px;pointer-events:all;padding:20px}
#intro h1{font-family:'Cinzel Decorative',serif;font-size:clamp(26px,7vw,64px);color:#4400aa;text-shadow:3px 3px 0 rgba(255,255,255,.7);letter-spacing:4px}
#intro .tag{font-size:15px;color:#8800cc;font-weight:900;letter-spacing:2px}
#intro .sub{font-size:clamp(12px,2vw,14px);color:#553399;font-weight:700;max-width:360px;line-height:1.9}
.gbtn.start{margin-top:10px;font-size:20px;padding:16px 44px;animation:pulse 2s ease infinite}

@keyframes pop{from{opacity:0;transform:scale(.5)}to{opacity:1;transform:scale(1)}}
@keyframes kslide{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes pulse{0%,100%{box-shadow:0 4px 20px rgba(150,50,255,.4)}50%{box-shadow:0 4px 40px rgba(150,50,255,.8),0 0 20px rgba(255,150,0,.4)}}
</style>
</head>
<body>

<div id="intro">
  <h1>âš” ACORNIX âš”</h1>
  <div class="tag">Sorcerer's Last Stand</div>
  <div class="sub">
    ğŸ¯ Tap the screen to shoot towards that point<br>
    ğŸ’¥ Nova = destroys all nearby enemies<br>
    ğŸ›¡ï¸ Shield = 3 seconds of protection<br>
    Unlock new spells every few waves!
  </div>
  <button class="gbtn start" id="start-btn">BEGIN SIEGE!</button>
</div>

<div id="hud">
  <div id="top-bar">
    <div class="panel">
      <div class="plabel">Castle</div>
      <div class="pval" id="hp-text">100%</div>
      <div id="hp-wrap"><div id="hp-fill"></div></div>
    </div>
    <div class="panel" id="spell-panel">
      <span id="spell-icon">âœ¨</span>
      <span id="spell-name">Magic Spark</span>
    </div>
    <div class="panel">
      <div class="plabel">Wave</div>
      <div class="pval" id="wave-num">1</div>
      <div class="plabel" style="margin-top:4px">Kills</div>
      <div class="pval" id="score-num">0</div>
    </div>
  </div>

  <div id="wave-ann"><div class="wt" id="wave-t"></div><div class="ws" id="wave-s"></div></div>
  <div id="unlock-msg"><div class="ut" id="ul-t"></div><div class="us">Spell Unlocked!</div></div>
  <div id="kfeed"></div>
  <div id="aim-dot"></div>
  <div id="dmg-flash"></div>

  <div id="controls">
    <div id="spell-bar">
      <div class="sslot sel"    data-i="0">âœ¨<span class="sk">lv1</span></div>
      <div class="sslot locked" data-i="1">â„ï¸<span class="sk">lv2</span></div>
      <div class="sslot locked" data-i="2">âš¡<span class="sk">lv3</span></div>
      <div class="sslot locked" data-i="3">ğŸ¦…<span class="sk">lv5</span></div>
      <div class="sslot locked" data-i="4">â˜„ï¸<span class="sk">lv8</span></div>
    </div>
    <div id="ability-bar">
      <div class="abtn" id="nova-btn">ğŸ’¥<span class="alabel">NOVA</span><div class="acd" id="cd-nova"></div></div>
      <div class="abtn" id="shield-btn">ğŸ›¡ï¸<span class="alabel">SHIELD</span><div class="acd" id="cd-shield"></div></div>
    </div>
  </div>
</div>

<div id="gameover">
  <h1>ğŸ’€ FALLEN ğŸ’€</h1>
  <div class="fscore" id="fscore">Kills: 0 Â· Wave: 1</div>
  <button class="gbtn" id="restart-btn">RISE AGAIN!</button>
</div>

<script type="importmap">{"imports":{"three":"https://unpkg.com/three@0.160.0/build/three.module.js"}}</script>
<script type="module">
import * as THREE from 'three';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let score=0, wave=1, hp=100, running=false;
let lastFire=0, firing=false;
let novaUsed=0, shieldUsed=0, shieldActive=false;
const NOVA_CD=8000, SHIELD_CD=12000, SHIELD_DUR=3000;
let wKills=0, wTarget=7, wPhase='active', wGap=0;
const WAVE_GAP=3500;
let spawnAcc=0, sel=0;

// Touch aim
let aimX=0.5, aimY=0.35; 

const enemies=[], bullets=[], parts=[], ftexts=[];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPELLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SPELLS=[
  {name:'Magic Spark', icon:'âœ¨', col:0xff8800, count:1, spread:0,   rate:500, sz:.32, spd:.85, unlock:1},
  {name:'Frost Bolt',  icon:'â„ï¸', col:0x44ccff, count:1, spread:0,   rate:380, sz:.38, spd:1.1, unlock:2},
  {name:'Double Ray',  icon:'âš¡', col:0xffee00, count:2, spread:.13, rate:310, sz:.35, spd:1.0, unlock:3},
  {name:'Phoenix Fire',icon:'ğŸ¦…', col:0xff4400, count:3, spread:.20, rate:240, sz:.40, spd:1.2, unlock:5},
  {name:'Void Rain',   icon:'â˜„ï¸', col:0xcc44ff, count:5, spread:.28, rate:165, sz:.42, spd:1.35,unlock:8},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREE.JS & CAMERA ADAPTATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);
scene.fog=new THREE.Fog(0x87ceeb,40,90);

const camera=new THREE.PerspectiveCamera(65, innerWidth/innerHeight, 0.1, 200);

// CÃMARA DINÃMICA: Sube y se aleja en mÃ³viles para ver todo el terreno
function updateCamera() {
  if (innerWidth < innerHeight) {
    camera.position.set(0, 18, 36); 
    camera.lookAt(0, 1, 0);
  } else {
    camera.position.set(0, 12, 30);
    camera.lookAt(0, 1, 0);
  }
}
updateCamera();

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(Math.min(devicePixelRatio,1.5)); 
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
renderer.shadowMap.type=THREE.PCFSoftShadowMap;
renderer.toneMapping=THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure=1.4;
document.body.appendChild(renderer.domElement);

// Lighting 
const sun=new THREE.DirectionalLight(0xfff5e0,1.6);
sun.position.set(20,40,20);
sun.castShadow=true;
sun.shadow.mapSize.set(1024,1024);
sun.shadow.camera.left=-60; sun.shadow.camera.right=60;
sun.shadow.camera.top=60; sun.shadow.camera.bottom=-60;
scene.add(sun);
scene.add(new THREE.AmbientLight(0xcceeff,0.9));
const fillLight=new THREE.DirectionalLight(0xffd0aa,0.5);
fillLight.position.set(-20,10,5); scene.add(fillLight);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORLD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const gnd=new THREE.Mesh(
  new THREE.PlaneGeometry(140,140),
  new THREE.MeshStandardMaterial({color:0x66cc44,roughness:.9})
);
gnd.rotation.x=-Math.PI/2; gnd.receiveShadow=true; scene.add(gnd);

const path=new THREE.Mesh(
  new THREE.PlaneGeometry(10,140),
  new THREE.MeshStandardMaterial({color:0xcc9966,roughness:.95})
);
path.rotation.x=-Math.PI/2; path.position.y=.01; scene.add(path);

[[0,22,-40],[15,25,-20],[-18,20,-50],[30,24,-70]].forEach(([x,y,z])=>{
  const c=new THREE.Mesh(
    new THREE.SphereGeometry(6+Math.random()*4,8,6),
    new THREE.MeshStandardMaterial({color:0xffffff,roughness:1})
  );
  c.position.set(x,y,z); c.scale.set(1,.5,1); scene.add(c);
});

function tree(x,z){
  const g=new THREE.Group();
  const trunk=new THREE.Mesh(new THREE.CylinderGeometry(.4,.5,3,6),new THREE.MeshStandardMaterial({color:0x8B5E3C}));
  trunk.position.y=1.5; trunk.castShadow=true; g.add(trunk);
  const leaf=new THREE.Mesh(new THREE.SphereGeometry(2.5,8,6),new THREE.MeshStandardMaterial({color:0x44bb22}));
  leaf.position.y=5; leaf.castShadow=true; g.add(leaf);
  g.position.set(x,.0,z); scene.add(g);
}
[[-18,-10],[18,-10],[-22,-30],[22,-30],[-16,-50],[16,-50],[-20,-70],[20,-70],[-24,0],[24,0]].forEach(([x,z])=>tree(x,z));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CASTLE (ALTURA REDUCIDA PARA VISIBILIDAD)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{
  const g=new THREE.Group();
  const stone=new THREE.MeshStandardMaterial({color:0xddccbb,roughness:.7,metalness:.05});
  const roof=new THREE.MeshStandardMaterial({color:0xdd3366,roughness:.6});

  // Muro Principal (SÃºper bajo para no tapar)
  const wall=new THREE.Mesh(new THREE.BoxGeometry(48, 1.2, 3.5), stone);
  wall.position.set(0, 0.6, 0); wall.castShadow=true; wall.receiveShadow=true; g.add(wall);

  // Almenas (Crenellations) bien visibles
  for(let x=-22;x<=22;x+=3){
    const cr=new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.8, 3.5), new THREE.MeshStandardMaterial({color:0xccbbaa,roughness:.7}));
    cr.position.set(x, 1.6, 0); cr.castShadow=true; g.add(cr);
  }

  // Torres Bajas
  [-24,24].forEach(tx=>{
    const tw=new THREE.Mesh(new THREE.CylinderGeometry(3.5, 4, 4, 8), stone);
    tw.position.set(tx, 2, 0); tw.castShadow=true; g.add(tw);
    
    const cap=new THREE.Mesh(new THREE.ConeGeometry(4, 3.5, 8), roof);
    cap.position.set(tx, 5.5, 0); g.add(cap);
    
    const flag=new THREE.Mesh(new THREE.PlaneGeometry(2,1.5),new THREE.MeshStandardMaterial({color:0xff5500,side:THREE.DoubleSide}));
    flag.position.set(tx+1, 7.5, 0); g.add(flag);
  });

  g.position.z=14; scene.add(g);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANNON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const cannon=new THREE.Group();
cannon.add(new THREE.Mesh(
  new THREE.CylinderGeometry(1.5,1.9,1,10),
  new THREE.MeshStandardMaterial({color:0x775599,roughness:.4,metalness:.5})
));
const tube=new THREE.Mesh(
  new THREE.CylinderGeometry(.4,.56,3.8),
  new THREE.MeshStandardMaterial({color:0x442266,roughness:.3,metalness:.7})
);
tube.rotation.x=Math.PI/2; tube.position.z=-1.2; cannon.add(tube);
const muzzle=new THREE.Mesh(
  new THREE.SphereGeometry(.45,8,8),
  new THREE.MeshBasicMaterial({color:0xffaa00,transparent:true,opacity:.9})
);
muzzle.position.z=-3.1; cannon.add(muzzle);
const muzzleLight=new THREE.PointLight(0xffaa00,2,8);
muzzleLight.position.z=-3.1; cannon.add(muzzleLight);

// CaÃ±Ã³n bajado para coincidir con el muro nuevo
cannon.position.set(0,2.5,14); scene.add(cannon);

[[2,.003,0xffcc00],[4,-.002,0xff6600],[6,.0015,0xaa44ff]].forEach(([r,spd,col])=>{
  const rm=new THREE.Mesh(
    new THREE.RingGeometry(r-.07,r,32),
    new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:.4,side:THREE.DoubleSide})
  );
  rm.rotation.x=-Math.PI/2; rm.position.set(0,.02,14); rm.userData.rs=spd;
  scene.add(rm);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENEMY TYPES (Speeds balanced for progression)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ET=[
  {name:'Goblin', bc:0xff4444,hc:0xcc2222,hp:1,spd:.022,sc:.72,pts:1,eyeC:0xffff00},
  {name:'Orc',    bc:0x44cc44,hc:0x229922,hp:3,spd:.014,sc:1.1, pts:3,eyeC:0xff8800},
  {name:'Troll',  bc:0x4488ff,hc:0x2255cc,hp:7,spd:.009,sc:1.8, pts:8,eyeC:0xff0000},
  {name:'Spectre',bc:0xcc44ff,hc:0x8811cc,hp:2,spd:.030,sc:.82,pts:4,eyeC:0xffffff},
];

function pickType(){
  const r=Math.random();
  if(wave<=2) return ET[0];
  if(wave<=4) return r<.6?ET[0]:ET[1];
  if(wave<=7){
    if(r<.32) return ET[0]; if(r<.65) return ET[1]; if(r<.86) return ET[3]; return ET[2];
  }
  if(r<.18) return ET[0]; if(r<.46) return ET[1]; if(r<.68) return ET[3]; return ET[2];
}

function makeEnemy(type){
  const g=new THREE.Group();
  const bm=new THREE.MeshStandardMaterial({color:type.bc,roughness:.7});
  const hm=new THREE.MeshStandardMaterial({color:type.hc,roughness:.6});

  const body=new THREE.Mesh(new THREE.BoxGeometry(1,1.5,1),bm);
  body.position.y=1.0; body.castShadow=true; g.add(body);

  const head=new THREE.Mesh(new THREE.BoxGeometry(.8,.8,.8),hm);
  head.position.y=2.1; head.castShadow=true; g.add(head);

  const em=new THREE.MeshBasicMaterial({color:type.eyeC});
  const eg=new THREE.SphereGeometry(.1,5,5);
  [-0.18,0.18].forEach(ex=>{ const e=new THREE.Mesh(eg,em); e.position.set(ex,2.15,.42); g.add(e); });

  if(type.sc>1){
    const club=new THREE.Mesh(new THREE.CylinderGeometry(.12,.2,2,6),new THREE.MeshStandardMaterial({color:0x885533}));
    club.position.set(.8,1,0); club.rotation.z=-.3; g.add(club);
  }

  const bgm=new THREE.MeshBasicMaterial({color:0x440000,transparent:true,opacity:.7,depthTest:false});
  const fgm=new THREE.MeshBasicMaterial({color:0x44ff44,depthTest:false});
  const barBg=new THREE.Mesh(new THREE.PlaneGeometry(1,.14),bgm);
  const barFg=new THREE.Mesh(new THREE.PlaneGeometry(1,.14),fgm.clone());
  const by=3.4/type.sc;
  barBg.position.set(0,by,.01); barFg.position.set(0,by,.02);
  barBg.renderOrder=9; barFg.renderOrder=10;
  g.add(barBg,barFg);

  g.scale.setScalar(type.sc);
  g.userData={hp:type.hp,maxHp:type.hp,type,speed:type.spd*(1+wave*.05),t:Math.random()*10,wob:Math.random()*Math.PI*2,barFg};
  return g;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOOTING (CON FÃSICA PARABÃ“LICA)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const raycaster=new THREE.Raycaster();
const groundPlane=new THREE.Plane(new THREE.Vector3(0,1,0),0);

function getAimPoint(nx,ny){
  raycaster.setFromCamera(new THREE.Vector2(nx,ny),camera);
  const pt=new THREE.Vector3();
  const hit = raycaster.ray.intersectPlane(groundPlane,pt);
  
  if(!hit){
      raycaster.ray.at(100, pt); 
      pt.y = 0; 
  }
  
  return pt; // Devolvemos el PUNTO EXACTO, no solo la direcciÃ³n
}

function fireBullet(angleOff, targetPt){
  const sp=SPELLS[sel];
  const b=new THREE.Mesh(
    new THREE.SphereGeometry(sp.sz,8,8),
    new THREE.MeshBasicMaterial({color:sp.col})
  );
  
  const startPos = cannon.position.clone();
  startPos.y += 1.5; // Ajuste del caÃ±Ã³n
  b.position.copy(startPos);

  // --- MATEMÃTICAS DE FÃSICA PARABÃ“LICA ---
  const gravity = 0.025; // Fuerza de la gravedad
  const dx = targetPt.x - startPos.x;
  const dz = targetPt.z - startPos.z;
  const distH = Math.sqrt(dx*dx + dz*dz); // Distancia horizontal
  
  const t = distH / sp.spd; // Tiempo de vuelo estimado
  const dy = 1.0 - startPos.y; // Objetivo a 1.0 de altura (centro del orco)
  
  // Calcular las velocidades necesarias
  const vy = (dy + 0.5 * gravity * t * t) / t; // Velocidad vertical (hacia arriba)
  const vx = dx / t; // Velocidad X constante
  const vz = dz / t; // Velocidad Z constante

  let vel = new THREE.Vector3(vx, vy, vz);
  if(angleOff) vel.applyAxisAngle(new THREE.Vector3(0,1,0), angleOff);

  const bl=new THREE.PointLight(sp.col,2,5); b.add(bl);
  // Guardamos la gravedad dentro de userData para aplicarla luego
  b.userData={vel:vel, spell:sp, tt:0, grav: gravity};
  bullets.push(b); scene.add(b);
  emitBurst(startPos, sp.col, 4, .1);
}

function doFire(nx,ny){
  if(!running) return;
  const now=Date.now();
  const sp=SPELLS[sel];
  if(now-lastFire<sp.rate) return;
  lastFire=now;
  
  const targetPt=getAimPoint(nx,ny); // Conseguir coordenada
  if(!targetPt || isNaN(targetPt.x)) return;
  
  const c=sp.count;
  if(c===1){ fireBullet(0,targetPt); }
  else{
    for(let i=0;i<c;i++){
      const a=(i/(c-1)-.5)*sp.spread*2;
      setTimeout(()=>fireBullet(a,targetPt),i*22);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function emitBurst(pos,col,n,sz){
  for(let i=0;i<n;i++){
    const p=new THREE.Mesh(new THREE.SphereGeometry(sz*(0.5+Math.random()*.5),4,4),new THREE.MeshBasicMaterial({color:col}));
    p.position.copy(pos);
    const s=.1+Math.random()*.2, th=Math.random()*Math.PI*2, ph=Math.random()*Math.PI;
    p.userData={vel:new THREE.Vector3(Math.sin(ph)*Math.cos(th)*s,Math.abs(Math.cos(ph))*s*1.3,Math.sin(ph)*Math.sin(th)*s),life:1,decay:.028+Math.random()*.016,gravity:true,isP:true};
    parts.push(p); scene.add(p);
  }
}
function emitRing(pos,col,big){
  const r=new THREE.Mesh(new THREE.RingGeometry(.2,.8,24),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:.8,side:THREE.DoubleSide,depthTest:false}));
  r.position.copy(pos); r.position.y=.05; r.rotation.x=-Math.PI/2; r.renderOrder=5;
  r.userData={life:1,decay:.032,isRing:true,big:!!big};
  parts.push(r); scene.add(r);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FLOATING TEXT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnFT(txt,wpos){
  const d=document.createElement('div');
  d.style.cssText='position:absolute;pointer-events:none;font-family:Nunito,sans-serif;font-size:16px;color:#ff6600;text-shadow:1px 1px 0 #fff;font-weight:900;z-index:15;white-space:nowrap';
  d.textContent=txt; document.body.appendChild(d);
  ftexts.push({el:d,pos:wpos.clone(),life:1});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ABILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.castNova=function(){
  if(!running) return;
  if(Date.now()-novaUsed<NOVA_CD) return;
  novaUsed=Date.now();
  [...enemies].forEach(e=>{
    emitBurst(e.position.clone().setY(1.5),e.userData.type.bc,14,.2);
    emitRing(e.position.clone(),0xffee00,false);
    killEnemy(e);
  });
  emitRing(new THREE.Vector3(0,.01,14),0xffee00,true);
};

window.castShield=function(){
  if(!running) return;
  if(Date.now()-shieldUsed<SHIELD_CD) return;
  shieldUsed=Date.now(); shieldActive=true;
  const dome=new THREE.Mesh(new THREE.SphereGeometry(12,12,12),new THREE.MeshBasicMaterial({color:0x44aaff,transparent:true,opacity:.14,side:THREE.DoubleSide,wireframe:true}));
  dome.position.set(0,4,14);
  dome.userData={life:1,decay:1/(SHIELD_DUR/16),isRing:true};
  parts.push(dome); scene.add(dome);
  setTimeout(()=>shieldActive=false,SHIELD_DUR);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPELL SELECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.selectSpell=function(idx){
  if(SPELLS[idx].unlock>wave) return;
  sel=idx;
  document.querySelectorAll('.sslot').forEach((el,i)=>el.classList.toggle('sel',i===idx&&!el.classList.contains('locked')));
  document.getElementById('spell-icon').textContent=SPELLS[idx].icon;
  document.getElementById('spell-name').textContent=SPELLS[idx].name;
};
document.querySelectorAll('.sslot').forEach(el=>el.addEventListener('touchstart',e=>{e.stopPropagation();window.selectSpell(+el.dataset.i);},{passive:false}));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KILL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function killEnemy(e){
  const i=enemies.indexOf(e); if(i===-1)return;
  enemies.splice(i,1); scene.remove(e);
  score+=e.userData.type.pts; wKills++;
  document.getElementById('score-num').textContent=score;
  addKF(e.userData.type.name+' defeated!');
}
function addKF(txt){
  const feed=document.getElementById('kfeed');
  const d=document.createElement('div'); d.className='kitem'; d.textContent=txt; feed.appendChild(d);
  while(feed.children.length>5)feed.removeChild(feed.children[0]);
  setTimeout(()=>{if(d.parentNode)d.parentNode.removeChild(d);},2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startWave(w){
  wave=w; wKills=0; 
  wTarget = 4 + w * 3; 
  wPhase='active'; spawnAcc=0;
  
  document.getElementById('wave-num').textContent=w;
  document.getElementById('wave-t').textContent='âš” WAVE '+w+' âš”';
  const subs=['The siege begins!','The horde grows!','More enemies!','They never stop!','TOTAL WAR!'];
  document.getElementById('wave-s').textContent=subs[Math.min(w-1,4)];
  const ann=document.getElementById('wave-ann'); ann.style.display='block';
  setTimeout(()=>ann.style.display='none',2200);
  updateUnlocks();
}

function updateUnlocks(){
  let best=sel;
  document.querySelectorAll('.sslot').forEach((el,i)=>{
    const locked=SPELLS[i].unlock>wave;
    el.classList.toggle('locked',locked);
    if(!locked) best=Math.max(best,i);
  });
  if(best!==sel){ sel=best; showUnlock(SPELLS[best]); }
  document.querySelectorAll('.sslot').forEach((el,i)=>el.classList.toggle('sel',i===sel&&!el.classList.contains('locked')));
  document.getElementById('spell-icon').textContent=SPELLS[sel].icon;
  document.getElementById('spell-name').textContent=SPELLS[sel].name;
}

function showUnlock(sp){
  document.getElementById('ul-t').textContent=sp.icon+' '+sp.name+' '+sp.icon;
  const m=document.getElementById('unlock-msg'); m.style.display='block';
  setTimeout(()=>m.style.display='none',2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOUCH INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const aimDot=document.getElementById('aim-dot');

function getNDC(touch){
  return {
    nx:(touch.clientX/innerWidth)*2-1,
    ny:-(touch.clientY/innerHeight)*2+1,
    cx:touch.clientX, cy:touch.clientY
  };
}

let fireTouchId=null;
let fireNX=0,fireNY=0;

function isUITouch(cy){ return cy > innerHeight - 140; }

document.addEventListener('touchstart',e=>{
  for(const t of e.changedTouches){
    if(isUITouch(t.clientY)) continue; 
    if(fireTouchId===null){
      fireTouchId=t.identifier;
      const {nx,ny,cx,cy}=getNDC(t);
      fireNX=nx; fireNY=ny;
      aimDot.style.display='block';
      aimDot.style.left=cx+'px'; aimDot.style.top=cy+'px';
      doFire(nx,ny);
      firing=true;
    }
  }
},{passive:false});

document.addEventListener('touchmove',e=>{
  e.preventDefault();
  for(const t of e.changedTouches){
    if(t.identifier===fireTouchId){
      const {nx,ny,cx,cy}=getNDC(t);
      fireNX=nx; fireNY=ny;
      aimDot.style.left=cx+'px'; aimDot.style.top=cy+'px';
    }
  }
},{passive:false});

document.addEventListener('touchend',e=>{
  for(const t of e.changedTouches){
    if(t.identifier===fireTouchId){ fireTouchId=null; firing=false; aimDot.style.display='none'; }
  }
});

document.getElementById('nova-btn').addEventListener('touchstart',e=>{e.stopPropagation();castNova();},{passive:false});
document.getElementById('shield-btn').addEventListener('touchstart',e=>{e.stopPropagation();castShield();},{passive:false});
document.getElementById('nova-btn').addEventListener('click',()=>castNova());
document.getElementById('shield-btn').addEventListener('click',()=>castShield());

let mouseDown=false, mouseNX=0, mouseNY=0;
document.addEventListener('mousedown',e=>{
  if(e.target.closest('#controls')||e.target.closest('#hud')||e.target.closest('#gameover')||e.target.closest('#intro')) return;
  mouseDown=true; mouseNX=(e.clientX/innerWidth)*2-1; mouseNY=-(e.clientY/innerHeight)*2+1;
  doFire(mouseNX,mouseNY);
  aimDot.style.display='block'; aimDot.style.left=e.clientX+'px'; aimDot.style.top=e.clientY+'px';
});
document.addEventListener('mousemove',e=>{
  if(!mouseDown) return;
  mouseNX=(e.clientX/innerWidth)*2-1; mouseNY=-(e.clientY/innerHeight)*2+1;
  aimDot.style.left=e.clientX+'px'; aimDot.style.top=e.clientY+'px';
});
document.addEventListener('mouseup',()=>{ mouseDown=false; aimDot.style.display='none'; });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME OVER / RESTART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gameOver(){
  running=false;
  document.getElementById('fscore').textContent=`Kills: ${score} Â· Wave: ${wave}`;
  document.getElementById('gameover').classList.add('show');
  enemies.forEach(e=>scene.remove(e)); enemies.length=0;
  bullets.forEach(b=>scene.remove(b)); bullets.length=0;
}

document.getElementById('restart-btn').addEventListener('click',resetGame);
document.getElementById('restart-btn').addEventListener('touchstart',e=>{e.stopPropagation();resetGame();},{passive:false});

function resetGame(){
  score=0; wave=1; hp=100; lastFire=0; sel=0;
  wKills=0; wTarget=7; wPhase='active';
  novaUsed=0; shieldUsed=0; shieldActive=false; firing=false; fireTouchId=null; mouseDown=false;
  enemies.forEach(e=>scene.remove(e)); enemies.length=0;
  bullets.forEach(b=>scene.remove(b)); bullets.length=0;
  parts.forEach(p=>scene.remove(p)); parts.length=0;
  ftexts.forEach(f=>f.el.remove()); ftexts.length=0;
  document.getElementById('score-num').textContent='0';
  document.getElementById('hp-fill').style.width='100%';
  document.getElementById('hp-text').textContent='100%';
  document.getElementById('gameover').classList.remove('show');
  document.getElementById('kfeed').innerHTML='';
  document.querySelectorAll('.sslot').forEach((el,i)=>{el.classList.toggle('locked',i>0);el.classList.toggle('sel',i===0);});
  
  running=true; 
  startWave(1);
  
  lastT = performance.now();
  requestAnimationFrame(loop); 
}

// START
document.getElementById('start-btn').addEventListener('click',startGame);
document.getElementById('start-btn').addEventListener('touchstart',e=>{e.stopPropagation();startGame();},{passive:false});
function startGame(){
  document.getElementById('intro').style.display='none';
  running=true; 
  startWave(1); 
  lastT = performance.now();
  requestAnimationFrame(loop);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COOLDOWN UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateCD(){
  const now=Date.now();
  const nr=Math.max(0,NOVA_CD-(now-novaUsed));
  const sr=Math.max(0,SHIELD_CD-(now-shieldUsed));
  const cdN=document.getElementById('cd-nova'), cdS=document.getElementById('cd-shield');
  if(nr>0){cdN.classList.add('show');cdN.textContent=(nr/1000).toFixed(1)+'s';}else cdN.classList.remove('show');
  if(sr>0){cdS.classList.add('show');cdS.textContent=(sr/1000).toFixed(1)+'s';}else cdS.classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAMAGE FLASH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const dmgFlash=document.getElementById('dmg-flash');
function flashDamage(){
  dmgFlash.style.background='rgba(255,0,0,.35)';
  setTimeout(()=>dmgFlash.style.background='rgba(255,0,0,0)',150);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastT=0;
function loop(ts){
  if(!running){ renderer.render(scene,camera); return; }
  requestAnimationFrame(loop);
  const dt=Math.min(ts-lastT,50); lastT=ts;
  const t=ts*.001;

  if(firing) doFire(fireNX,fireNY);
  if(mouseDown) doFire(mouseNX,mouseNY);

  // ROTACIÃ“N DEL CAÃ‘Ã“N CORREGIDA PARA PUNTOS
  if(firing||mouseDown){
    const nx=firing?fireNX:mouseNX, ny=firing?fireNY:mouseNY;
    const targetPt=getAimPoint(nx,ny);
    if(targetPt&&!isNaN(targetPt.x)){
      const dx = targetPt.x - cannon.position.x;
      const dz = targetPt.z - cannon.position.z;
      const tY=Math.atan2(-dx,-dz);
      cannon.rotation.y+=(tY-cannon.rotation.y)*.15;
    }
  }

  muzzleLight.intensity=1.5+Math.sin(t*5)*.6;
  muzzle.material.opacity=.6+Math.sin(t*4)*.25;

  scene.children.forEach(c=>{ if(c.userData.rs) c.rotation.z+=c.userData.rs; });

  // â”€â”€â”€ SPAWN ANTI-PUNTOS CIEGOS EN MÃ“VIL â”€â”€â”€
  if(wPhase==='active'){
    spawnAcc+=dt;
    const interval=Math.max(400, 2500 - wave*200);
    const queued=wKills+enemies.length;
    const maxOnScreen = 2 + Math.floor(wave * 1.5);
    
    // Detectar si estamos en mÃ³vil para no generar enemigos fuera de cÃ¡mara
    const isMobile = innerWidth < innerHeight;
    const spawnWidth = isMobile ? 18 : 44; 
    
    while(spawnAcc>=interval && enemies.length < maxOnScreen && queued<wTarget){
      spawnAcc-=interval;
      const type=pickType();
      const e=makeEnemy(type);
      e.position.set((Math.random()-.5)*spawnWidth, 0, -46-Math.random()*12);
      enemies.push(e); scene.add(e);
    }
    if(wKills>=wTarget && enemies.length===0){
      wPhase='gap'; wGap=Date.now(); addKF('Wave '+wave+' complete! âœ“');
    }
  } else if(wPhase==='gap'){
    if(Date.now()-wGap>WAVE_GAP) startWave(wave+1);
  }

  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    e.userData.t+=.05;
    e.position.z+=e.userData.speed;
    e.position.x+=Math.sin(e.userData.t+e.userData.wob)*.011;
    e.position.y=Math.abs(Math.sin(e.userData.t))*.15;
    e.rotation.y=Math.atan2(camera.position.x-e.position.x,camera.position.z-e.position.z);

    const ratio=e.userData.hp/e.userData.maxHp;
    const bf=e.userData.barFg;
    if(bf){ bf.scale.x=ratio; bf.position.x=(ratio-1)*.5; bf.material.color.set(ratio>.5?0x44ff44:ratio>.25?0xffaa00:0xff2200); }

    if(e.position.z>13){
      if(!shieldActive){
        hp=Math.max(0,hp-e.userData.type.hp*5);
        document.getElementById('hp-fill').style.width=hp+'%';
        document.getElementById('hp-text').textContent=hp+'%';
        flashDamage();
        if(hp<=0){ gameOver(); return; }
      }
      emitBurst(new THREE.Vector3(e.position.x,2,13),0xff4444,8,.18);
      scene.remove(e); enemies.splice(i,1); wKills++;
    }
  }

  // â”€â”€â”€ BALAS Y GRAVEDAD â”€â”€â”€
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];
    b.position.add(b.userData.vel);
    
    // APLICAMOS LA GRAVEDAD
    b.userData.vel.y -= b.userData.grav; 
    
    b.userData.tt++;
    if(b.userData.tt%2===0){
      const tr=new THREE.Mesh(new THREE.SphereGeometry(b.userData.spell.sz*.34,4,4),new THREE.MeshBasicMaterial({color:b.userData.spell.col,transparent:true,opacity:.55}));
      tr.position.copy(b.position);
      tr.userData={life:.55,decay:.1,isP:true};
      parts.push(tr); scene.add(tr);
    }
    
    // DESTRUIR SI CHOCA CONTRA EL SUELO O SE ALEJA DEMASIADO
    if(b.position.y < -1 || b.position.z<-80 || b.position.z>20){ 
        scene.remove(b); bullets.splice(i,1); continue; 
    }
    
    let hit=false;
    for(let j=enemies.length-1;j>=0;j--){
      const e=enemies[j];
      const hr=1.2*e.userData.type.sc;
      if(b.position.distanceTo(e.position.clone().setY(e.position.y+1.2*e.userData.type.sc))<hr){
        e.userData.hp--;
        if(e.userData.hp<=0){
          emitBurst(e.position.clone().setY(1.5),e.userData.type.bc,16,.2);
          emitRing(e.position.clone(),e.userData.type.bc,false);
          spawnFT('+'+e.userData.type.pts,e.position.clone().setY(3.5));
          killEnemy(e);
        } else {
          emitBurst(e.position.clone().setY(1.5),0xffcc00,5,.13);
        }
        scene.remove(b); bullets.splice(i,1); hit=true; break;
      }
    }
    if(hit) continue;
  }

  for(let i=parts.length-1;i>=0;i--){
    const p=parts[i];
    p.userData.life-=(p.userData.decay||.025);
    if(p.userData.life<=0){ scene.remove(p); parts.splice(i,1); continue; }
    if(p.userData.vel){ p.position.add(p.userData.vel); if(p.userData.gravity) p.userData.vel.y-=.009; }
    if(p.material) p.material.opacity=p.userData.life;
    if(p.userData.isRing){ const s=p.userData.big?1+(1-p.userData.life)*22:1+(1-p.userData.life)*1.8; p.scale.setScalar(s); }
    else if(p.userData.isP) p.scale.setScalar(Math.max(0,p.userData.life));
  }

  for(let i=ftexts.length-1;i>=0;i--){
    const f=ftexts[i]; f.life-=.022; f.pos.y+=.04;
    if(f.life<=0){ f.el.remove(); ftexts.splice(i,1); continue; }
    const pr=f.pos.clone().project(camera);
    if(pr.z>=1){ f.el.style.opacity=0; continue; }
    f.el.style.left=((pr.x*.5+.5)*innerWidth)+'px';
    f.el.style.top=((-pr.y*.5+.5)*innerHeight)+'px';
    f.el.style.opacity=f.life;
    f.el.style.transform='translate(-50%,-50%) scale('+(0.6+f.life*.4)+')';
  }

  updateCD();
  renderer.render(scene,camera);
}

window.addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  updateCamera();
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

renderer.render(scene,camera);
</script>
</body>
</html>